<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Management</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <script src="https://code.jquery.com/jquery-3.7.1.js"
    integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
    crossorigin="anonymous"></script>

  <style>
    .hide { display: none; }
    .show { display: inline-block; }
  </style>
</head>
<body class="bg-light">

<div class="container py-4">
  <h2 class="text-center mb-4">üì¶ Order Management</h2>

  <!-- Form Card -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form id="orderForm" class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Product Name</label>
          <div class="input-group">
            <input type="text" class="form-control" id="ProdName" placeholder="Enter Product Name">
            <span class="input-group-text">
              <input type="checkbox" id="check" disabled>
            </span>
          </div>
        </div>
        <div class="col-md-3">
          <label class="form-label">Product Rate</label>
          <input type="text" class="form-control" id="ProdRate" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Available Qty</label>
          <input type="text" class="form-control" id="ProdQty" readonly>
        </div>

        <div class="col-md-6">
          <label class="form-label">Order Quantity</label>
          <input type="number" class="form-control" id="OrderQty" placeholder="Enter Quantity">
        </div>
        <div class="col-md-6">
          <label class="form-label">Order Value</label>
          <input type="text" class="form-control" id="OrderValue" readonly>
        </div>

        <!-- Hidden fields -->
        <input type="hidden" id="OrderID">
        <input type="hidden" id="ProdId">

        <div class="col-12 d-flex justify-content-end">
          <button type="button" id="btnSave" class="btn btn-success show me-2">üíæ Save Order</button>
          <button type="button" id="btnUpdate" class="btn btn-warning hide">‚úèÔ∏è Update Order</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Orders Table -->
  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="card-title mb-3">üìã Orders List</h5>
      <div class="table-responsive">
        <table id="tbl" class="table table-bordered table-hover align-middle text-center">
          <!-- Filled dynamically -->
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  $(document).ready(function(){
    // Fetch Orders
    $.ajax({
      url:'/orders',
      type:'GET',
      dataType:'json',
      success:function(response){
        let tblData=`<thead class="table-dark">
          <tr>
            <th>Sl No</th>
            <th>Product Name</th>
            <th>Order Date</th>
            <th>Rate</th>
            <th>Quantity</th>
            <th>Value</th>
            <th>Action</th>
          </tr>
        </thead><tbody>`;
        response.forEach((order,index)=>{
          tblData+=`<tr>
            <td>${index+1}</td>
            <td>${order.ProdId?.ProdName || ''}</td>
            <td>${new Date(order.OrderDate).toLocaleDateString()}</td>
            <td>${order.ProdRate}</td>
            <td>${order.OrderQty}</td>
            <td>${order.OrderValue}</td>
            <td>
              <button class="btn btn-sm btn-primary me-1" onclick="handleEdit('${order._id}')">Edit</button>
              <button class="btn btn-sm btn-danger" onclick="handleDelete('${order._id}')">Delete</button>
            </td>
          </tr>`;
        })
        tblData+=`</tbody>`;
        $('#tbl').html(tblData);
      }
    });

    // Fetch Product
    $('#ProdName').keyup(function(){
      let ProdName=$("#ProdName").val();
      $.ajax({
        url:'/fetchProduct',
        type:'GET',
        dataType:'json',
        data:{ProdName:ProdName},
        success:function(response){
          $('#check').prop('checked',!!response);
          $('#ProdId').val(response?response._id:'');
          $('#ProdRate').val(response?response.ProdRate:'');
          $('#ProdQty').val(response?response.ProdQty:'');
        }
      })
    });

    // Calculate Value
    $('#OrderQty').keyup(function(){
      let OrderQty=parseInt($('#OrderQty').val());
      let ProdQty=parseInt($('#ProdQty').val());
      let ProdRate=parseInt($('#ProdRate').val());
      if(OrderQty>ProdQty){
        alert('Order Qty should not be greater than Available Qty');
        $('#OrderQty').val('');
        $('#OrderValue').val('');
      }else{
        $('#OrderValue').val(OrderQty*ProdRate);
      }
    });

    // Save Order
    $('#btnSave').click(function(){
      let OrderDate=new Date().toISOString().slice(0,10);
      let ProdId=$('#ProdId').val();
      let OrderQty=$('#OrderQty').val();
      let ProdRate=$('#ProdRate').val();
      let OrderValue=$('#OrderValue').val();
      if(ProdId==''){ alert('Please select a valid product'); return; }
      $.ajax({
        url:'/orders',
        type:'POST',
        dataType:'json',
        data:{OrderDate,ProdId,OrderQty,ProdRate,OrderValue},
        success:function(response){
          alert(response);
          location.reload();
        }
      })
    });

    // Update Order
    $('#btnUpdate').click(function(){
      let id=$('#OrderID').val();
      let OrderQty=$('#OrderQty').val();
      let OrderValue=$('#OrderValue').val();
      if(id==''){ alert('Invalid Order ID'); return; }
      $.ajax({
        url:`/orders`,
        type:'PUT',
        dataType:'json',
        data:{id,OrderQty,OrderValue},
        success:function(response){
          alert(response);
          location.reload();
        }
      })
    });
  });

  function handleEdit(id){
    $('#btnSave').addClass('hide').removeClass('show');
    $('#btnUpdate').addClass('show').removeClass('hide');
    $('#ProdName').prop('readonly',true);
    $('#check').prop('checked',true);
    $.ajax({
      url:`/orders/${id}`,
      type:'GET',
      dataType:'json',
      success:function(order){
        $('#OrderID').val(order._id);
        $('#ProdId').val(order.ProdId._id);
        $('#ProdName').val(order.ProdId.ProdName);
        $('#ProdRate').val(order.ProdRate);
        $('#OrderQty').val(order.OrderQty);
        $('#OrderValue').val(order.OrderValue);
        $('#ProdQty').val(order.ProdId.ProdQty);
      }
    })
  }

  function handleDelete(id){
    if(confirm("Are you sure you want to delete this order?")){
      $.ajax({
        url:`/orders/${id}`,
        type:'DELETE',
        dataType:'json',
        success:function(response){
          alert(response);
          location.reload();
        }
      })
    }
  }
</script>
</body>
</html>
